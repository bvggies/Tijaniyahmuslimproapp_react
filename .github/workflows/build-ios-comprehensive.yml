name: Build iOS IPA (Comprehensive)

on:
  workflow_dispatch: # Manual trigger only
  push:
    branches: [ main ]
    paths:
      - 'ios/**'
      - 'app.json'
      - 'package.json'
      - 'src/**'

jobs:
  build-ios-ipa:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install dependencies
      run: |
        npm ci
        npx expo install --fix
        
    - name: Clean environment
      run: |
        rm -rf ios
        rm -rf .expo
        rm -rf node_modules/.cache
        rm -rf ~/.expo
        
    - name: Prebuild iOS project
      run: |
        npx expo prebuild --platform ios --clear --no-install
        
    - name: Install iOS dependencies
      run: |
        cd ios
        pod install --repo-update
        
    - name: Verify iOS project
      run: |
        cd ios
        echo "=== iOS Project Verification ==="
        ls -la
        echo ""
        echo "=== Workspace check ==="
        if [ -f "TijaniyahPro.xcworkspace" ]; then
          echo "‚úÖ Workspace found"
          ls -la TijaniyahPro.xcworkspace
        else
          echo "‚ùå No workspace found"
        fi
        echo ""
        echo "=== Project check ==="
        if [ -f "TijaniyahPro.xcodeproj" ]; then
          echo "‚úÖ Project found"
          ls -la TijaniyahPro.xcodeproj
        else
          echo "‚ùå No project found"
        fi
        echo ""
        echo "=== Pods check ==="
        ls -la Pods/
        
    - name: Build iOS App (No Code Signing)
      run: |
        cd ios
        
        # Build without code signing for development
        if [ -f "TijaniyahMuslimPro.xcworkspace" ]; then
          echo "‚úÖ Building with workspace (no code signing)..."
          xcodebuild -workspace TijaniyahMuslimPro.xcworkspace \
                     -scheme TijaniyahMuslimPro \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -derivedDataPath ./build \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     PROVISIONING_PROFILE="" \
                     build
        elif [ -f "TijaniyahMuslimPro.xcodeproj" ]; then
          echo "‚úÖ Building with project (no code signing)..."
          xcodebuild -project TijaniyahMuslimPro.xcodeproj \
                     -scheme TijaniyahMuslimPro \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -derivedDataPath ./build \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     PROVISIONING_PROFILE="" \
                     build
        else
          echo "‚ùå No iOS project found!"
          echo "Available files:"
          ls -la
          exit 1
        fi
        
    - name: Locate built app
      run: |
        cd ios
        echo "=== Searching for built app ==="
        find build -name "*.app" -type d
        echo ""
        echo "=== Build products ==="
        find build -name "*.app" -exec ls -la {} \;
        
    - name: Create IPA file
      run: |
        cd ios
        
        # Find the built app
        APP_PATH=$(find build -name "*.app" -type d | head -1)
        
        if [ -z "$APP_PATH" ]; then
          echo "‚ùå No app bundle found!"
          echo "Build directory contents:"
          find build -type f | head -20
          exit 1
        fi
        
        echo "‚úÖ Found app at: $APP_PATH"
        
        # Verify app structure
        ls -la "$APP_PATH"
        
        # Create Payload directory
        mkdir -p Payload
        
        # Copy the app to Payload
        cp -r "$APP_PATH" Payload/
        
        # Verify Payload
        ls -la Payload/
        
        # Create IPA
        zip -r TijaniyahPro.ipa Payload/
        
        echo "‚úÖ IPA created successfully!"
        ls -la *.ipa
        
        # Verify IPA contents
        unzip -l TijaniyahPro.ipa
        
    - name: Upload iOS IPA
      uses: actions/upload-artifact@v4
      with:
        name: tijaniyah-pro-ios-ipa
        path: ios/TijaniyahPro.ipa
        retention-days: 30
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      with:
        name: tijaniyah-pro-ios-build-logs
        path: ios/build/
        retention-days: 7
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ios/TijaniyahPro.ipa
        tag_name: ios-v1.0.0
        name: Tijaniyah Muslim Pro iOS v1.0.0
        body: |
          üçé **Tijaniyah Muslim Pro iOS Build**
          
          ## Features
          - ‚úÖ Prayer Times with Location Detection
          - ‚úÖ Qibla Compass with Sensors  
          - ‚úÖ Islamic Calendar (Hijri Dates)
          - ‚úÖ Azan Audio Player
          - ‚úÖ Digital Tasbih
          - ‚úÖ Islamic Lessons & Resources
          - ‚úÖ Community Features
          - ‚úÖ Donation System
          - ‚úÖ Multi-language Support
          - ‚úÖ Tijani Practices with Niyyah Supplications
          
          ## Installation
          This is a development build that can be installed via:
          - Xcode
          - Apple Configurator
          - Third-party app installers
          
          ## Ready for App Store! üöÄ
        draft: false
        prerelease: true
