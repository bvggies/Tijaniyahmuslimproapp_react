name: Build iOS IPA (Fixed)

on:
  workflow_dispatch: # Manual trigger only
  push:
    branches: [ main ]
    paths:
      - 'ios/**'
      - 'app.json'
      - 'package.json'

jobs:
  build-ios-ipa:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install dependencies
      run: |
        npm ci
        npx expo install --fix
        
    - name: Clean previous builds
      run: |
        rm -rf ios
        rm -rf .expo
        
    - name: Prebuild iOS project
      run: |
        npx expo prebuild --platform ios --clear
        
    - name: Install iOS dependencies
      run: |
        cd ios
        pod install --repo-update
        
    - name: List iOS project contents
      run: |
        cd ios
        ls -la
        echo "=== Checking for workspace ==="
        if [ -f "TijaniyahPro.xcworkspace" ]; then
          echo "‚úÖ Found TijaniyahPro.xcworkspace"
        else
          echo "‚ùå No workspace found"
        fi
        echo "=== Checking for project ==="
        if [ -f "TijaniyahPro.xcodeproj" ]; then
          echo "‚úÖ Found TijaniyahPro.xcodeproj"
        else
          echo "‚ùå No project found"
        fi
        
    - name: Build iOS App (Development Build)
      run: |
        cd ios
        if [ -f "TijaniyahPro.xcworkspace" ]; then
          echo "Building with workspace..."
          xcodebuild -workspace TijaniyahPro.xcworkspace \
                     -scheme TijaniyahPro \
                     -configuration Debug \
                     -destination 'platform=iOS Simulator,name=iPhone 16,OS=26.0' \
                     -derivedDataPath ./build \
                     build
        elif [ -f "TijaniyahPro.xcodeproj" ]; then
          echo "Building with project..."
          xcodebuild -project TijaniyahPro.xcodeproj \
                     -scheme TijaniyahPro \
                     -configuration Debug \
                     -destination 'platform=iOS Simulator,name=iPhone 16,OS=26.0' \
                     -derivedDataPath ./build \
                     build
        else
          echo "‚ùå No iOS project found!"
          exit 1
        fi
        
    - name: Create IPA for Distribution (No Code Signing)
      run: |
        cd ios
        echo "Creating IPA without code signing..."
        
        # Create Payload directory
        mkdir -p Payload
        
        # Copy the built app to Payload
        if [ -d "build/Build/Products/Debug-iphonesimulator/TijaniyahPro.app" ]; then
          cp -r build/Build/Products/Debug-iphonesimulator/TijaniyahPro.app Payload/
        else
          echo "‚ùå App bundle not found!"
          find build -name "*.app" -type d
          exit 1
        fi
        
        # Create IPA file
        zip -r TijaniyahPro.ipa Payload/
        
        echo "‚úÖ IPA created successfully!"
        ls -la *.ipa
        
    - name: Upload iOS IPA
      uses: actions/upload-artifact@v4
      with:
        name: tijaniyah-pro-ios-ipa
        path: ios/TijaniyahPro.ipa
        retention-days: 30
        
    - name: Upload iOS build logs
      uses: actions/upload-artifact@v4
      with:
        name: tijaniyah-pro-ios-build-logs
        path: ios/build/
        retention-days: 7
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ios/TijaniyahPro.ipa
        tag_name: ios-v1.0.0
        name: Tijaniyah Muslim Pro iOS v1.0.0
        body: |
          üçé **Tijaniyah Muslim Pro iOS Build**
          
          ## iOS App Features
          - ‚úÖ Prayer Times with Location Detection
          - ‚úÖ Qibla Compass with Sensors
          - ‚úÖ Islamic Calendar (Hijri Dates)
          - ‚úÖ Azan Audio Player
          - ‚úÖ Digital Tasbih
          - ‚úÖ Islamic Lessons & Resources
          - ‚úÖ Community Features
          - ‚úÖ Donation System
          - ‚úÖ Multi-language Support
          - ‚úÖ Tijani Practices with Niyyah
          
          ## Technical Notes
          - üîß Development build (no code signing)
          - üîß Requires manual installation via Xcode
          - üîß Tested on iOS Simulator
          - üîß Ready for App Store submission after code signing
          
          ## Installation Instructions
          1. Download the IPA file
          2. Install via Xcode or Apple Configurator
          3. Trust the developer certificate in Settings
          
          ## Ready for App Store! üöÄ
        draft: false
        prerelease: true
