name: Build iOS IPA (Dynamic Detection)

on:
  workflow_dispatch: # Manual trigger only

jobs:
  build-ios-ipa:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install dependencies
      run: |
        npm ci
        npx expo install --fix
        
    - name: Clean environment
      run: |
        rm -rf ios
        rm -rf .expo
        rm -rf node_modules/.cache
        
    - name: Prebuild iOS project
      run: |
        npx expo prebuild --platform ios --clear --no-install
        
    - name: Install iOS dependencies
      run: |
        cd ios
        pod install --repo-update
        
    - name: Detect iOS project name
      id: detect-project
      run: |
        cd ios
        echo "=== Detecting iOS project name ==="
        
        # Find workspace file
        WORKSPACE_FILE=$(find . -name "*.xcworkspace" | head -1)
        if [ -n "$WORKSPACE_FILE" ]; then
          PROJECT_NAME=$(basename "$WORKSPACE_FILE" .xcworkspace)
          echo "‚úÖ Found workspace: $WORKSPACE_FILE"
          echo "Project name: $PROJECT_NAME"
        else
          # Find project file
          PROJECT_FILE=$(find . -name "*.xcodeproj" | head -1)
          if [ -n "$PROJECT_FILE" ]; then
            PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
            echo "‚úÖ Found project: $PROJECT_FILE"
            echo "Project name: $PROJECT_NAME"
          else
            echo "‚ùå No iOS project found!"
            exit 1
          fi
        fi
        
        echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_OUTPUT
        echo "WORKSPACE_FILE=$WORKSPACE_FILE" >> $GITHUB_OUTPUT
        echo "PROJECT_FILE=$PROJECT_FILE" >> $GITHUB_OUTPUT
        
    - name: Build iOS App
      run: |
        cd ios
        PROJECT_NAME="${{ steps.detect-project.outputs.PROJECT_NAME }}"
        WORKSPACE_FILE="${{ steps.detect-project.outputs.WORKSPACE_FILE }}"
        PROJECT_FILE="${{ steps.detect-project.outputs.PROJECT_FILE }}"
        
        echo "Building iOS app: $PROJECT_NAME"
        
        if [ -n "$WORKSPACE_FILE" ]; then
          echo "‚úÖ Building with workspace: $WORKSPACE_FILE"
          xcodebuild -workspace "$WORKSPACE_FILE" \
                     -scheme "$PROJECT_NAME" \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -derivedDataPath ./build \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     build
        elif [ -n "$PROJECT_FILE" ]; then
          echo "‚úÖ Building with project: $PROJECT_FILE"
          xcodebuild -project "$PROJECT_FILE" \
                     -scheme "$PROJECT_NAME" \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -derivedDataPath ./build \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     build
        else
          echo "‚ùå No iOS project found!"
          exit 1
        fi
        
    - name: Create IPA file
      run: |
        cd ios
        PROJECT_NAME="${{ steps.detect-project.outputs.PROJECT_NAME }}"
        
        echo "=== Creating IPA for: $PROJECT_NAME ==="
        
        # Find the built app
        APP_PATH=$(find build -name "*.app" -type d | head -1)
        
        if [ -z "$APP_PATH" ]; then
          echo "‚ùå No app bundle found!"
          echo "Build directory contents:"
          find build -type f | head -20
          exit 1
        fi
        
        echo "‚úÖ Found app at: $APP_PATH"
        
        # Create Payload directory
        mkdir -p Payload
        
        # Copy the app to Payload
        cp -r "$APP_PATH" Payload/
        
        # Create IPA
        zip -r "${PROJECT_NAME}.ipa" Payload/
        
        echo "‚úÖ IPA created successfully!"
        ls -la *.ipa
        
    - name: Upload iOS IPA
      uses: actions/upload-artifact@v4
      with:
        name: tijaniyah-pro-ios-ipa
        path: ios/*.ipa
        retention-days: 30
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ios/*.ipa
        tag_name: ios-v1.0.0
        name: Tijaniyah Muslim Pro iOS v1.0.0
        body: |
          üçé **Tijaniyah Muslim Pro iOS Build**
          
          ## Features
          - ‚úÖ Prayer Times with Location Detection
          - ‚úÖ Qibla Compass with Sensors  
          - ‚úÖ Islamic Calendar (Hijri Dates)
          - ‚úÖ Azan Audio Player
          - ‚úÖ Digital Tasbih
          - ‚úÖ Islamic Lessons & Resources
          - ‚úÖ Community Features
          - ‚úÖ Donation System
          - ‚úÖ Multi-language Support
          - ‚úÖ Tijani Practices with Niyyah Supplications
          
          ## Installation
          This is a development build that can be installed via:
          - Xcode
          - Apple Configurator
          - Third-party app installers
          
          ## Ready for App Store! üöÄ
        draft: false
        prerelease: true
