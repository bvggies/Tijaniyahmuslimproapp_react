name: Build AAB for Google Play Production

on:
  workflow_dispatch: # Manual trigger
    inputs:
      version_code:
        description: 'Version Code (integer)'
        required: true
        default: '1'
      version_name:
        description: 'Version Name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
  push:
    branches:
      - main  # Trigger on push to main branch
    tags:
      - 'v*' # Trigger on version tags like v1.0.0

jobs:
  build-aab:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install dependencies
      run: |
        npm ci
        npx expo install --fix
        
    - name: Clean and generate Android project
      run: |
        # Remove existing android directory if it exists
        if [ -d "android" ]; then
          echo "Removing existing android directory"
          rm -rf android
        fi
        
        # Generate Android project
        echo "Generating Android project..."
        npx expo prebuild --platform android
        
        # Verify the project was created
        if [ -d "android" ]; then
          echo "‚úÖ Android project generated successfully"
        else
          echo "‚ùå Android project generation failed"
          exit 1
        fi
        
    - name: Setup signing keystore
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
      run: |
        echo "Setting up signing keystore..."
        mkdir -p android/app
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
        
        # Create or update gradle.properties with signing config
        KEYSTORE_PROPERTIES="android/gradle.properties"
        echo "" >> "$KEYSTORE_PROPERTIES"
        echo "# Production signing configuration" >> "$KEYSTORE_PROPERTIES"
        echo "MYAPP_UPLOAD_STORE_FILE=upload-keystore.jks" >> "$KEYSTORE_PROPERTIES"
        echo "MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> "$KEYSTORE_PROPERTIES"
        echo "MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> "$KEYSTORE_PROPERTIES"
        echo "MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> "$KEYSTORE_PROPERTIES"
        
    - name: Update version code and name
      run: |
        # Get version from inputs (manual trigger) or use defaults
        VERSION_CODE="${{ github.event.inputs.version_code }}"
        VERSION_NAME="${{ github.event.inputs.version_name }}"
        
        # Extract version from tag if triggered by tag
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION_NAME="${GITHUB_REF#refs/tags/v}"
          # Extract version code from tag or use commit count
          if [[ -z "$VERSION_CODE" ]]; then
            VERSION_CODE=$(git rev-list --count HEAD)
          fi
        fi
        
        # Use defaults if not provided
        if [[ -z "$VERSION_CODE" ]]; then
          # Increment based on previous version or use commit count
          CURRENT_CODE=$(grep -oP 'versionCode \K[0-9]+' android/app/build.gradle 2>/dev/null || echo "0")
          VERSION_CODE=$((CURRENT_CODE + 1))
        fi
        
        if [[ -z "$VERSION_NAME" ]]; then
          VERSION_NAME="1.0.0"
        fi
        
        echo "Setting versionCode=$VERSION_CODE and versionName=$VERSION_NAME"
        
        # Update build.gradle
        sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
        sed -i "s/versionName \".*\"/versionName \"$VERSION_NAME\"/" android/app/build.gradle
        
    - name: Configure release signing in build.gradle
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
      run: |
        # Use Python to properly modify build.gradle
        python3 << 'PYTHON_SCRIPT'
        import re
        
        build_gradle_path = 'android/app/build.gradle'
        with open(build_gradle_path, 'r') as f:
            content = f.read()
        
        # Check if signingConfigs already exists
        has_signing_configs = 'signingConfigs {' in content
        
        if not has_signing_configs:
            # Add signingConfigs block before buildTypes
            signing_config = '''
    signingConfigs {
        release {
            if (project.hasProperty("MYAPP_UPLOAD_STORE_FILE")) {
                storeFile file(MYAPP_UPLOAD_STORE_FILE)
                storePassword MYAPP_UPLOAD_STORE_PASSWORD
                keyAlias MYAPP_UPLOAD_KEY_ALIAS
                keyPassword MYAPP_UPLOAD_KEY_PASSWORD
            }
        }
    }
'''
            # Insert before buildTypes
            content = re.sub(r'(buildTypes\s*{)', signing_config + r'\1', content, count=1)
        else:
            # Add release config to existing signingConfigs
            release_config = '''
        release {
            if (project.hasProperty("MYAPP_UPLOAD_STORE_FILE")) {
                storeFile file(MYAPP_UPLOAD_STORE_FILE)
                storePassword MYAPP_UPLOAD_STORE_PASSWORD
                keyAlias MYAPP_UPLOAD_KEY_ALIAS
                keyPassword MYAPP_UPLOAD_KEY_PASSWORD
            }
        }'''
            # Insert after signingConfigs {
            content = re.sub(r'(signingConfigs\s*\{)', r'\1' + release_config, content, count=1)
        
        # Update release buildType to use production signing
        # Replace debug signing with release signing
        content = re.sub(
            r'signingConfig\s+signingConfigs\.debug',
            'signingConfig signingConfigs.release',
            content
        )
        
        # If no signingConfig in release block, add it
        if 'release {' in content and 'signingConfig' not in content.split('release {')[1].split('}')[0]:
            content = re.sub(
                r'(release\s*\{[^}]*?)(\})',
                r'\1            signingConfig signingConfigs.release\n        \2',
                content,
                flags=re.DOTALL
            )
        
        with open(build_gradle_path, 'w') as f:
            f.write(content)
        
        print("‚úÖ Signing configuration updated successfully")
        PYTHON_SCRIPT
        
    - name: Make gradlew executable
      run: |
        cd android
        chmod +x gradlew
        echo "Gradle wrapper is now executable"
        
    - name: Verify Gradle tasks
      run: |
        cd android
        echo "=== Available Gradle tasks ==="
        ./gradlew tasks --all --no-daemon | grep -E "(bundle|assemble)" || true
        echo ""
        echo "=== Verifying bundleRelease task exists ==="
        if ./gradlew tasks --all --no-daemon | grep -q "bundleRelease"; then
          echo "‚úÖ bundleRelease task found - will build AAB"
        else
          echo "‚ùå bundleRelease task not found!"
          exit 1
        fi
        
    - name: Disable APK building in build.gradle
      run: |
        # Modify build.gradle to prevent APK builds
        python3 << 'PYTHON_SCRIPT'
        import re
        
        build_gradle_path = 'android/app/build.gradle'
        with open(build_gradle_path, 'r') as f:
            content = f.read()
        
        # Add configuration to disable APK generation
        disable_apk_config = '''
    // Disable APK generation - only build AAB
    android.applicationVariants.all { variant ->
        if (variant.buildType.name == "release") {
            variant.outputs.all {
                // Disable APK generation
            }
        }
    }
'''
        
        # Insert before dependencies block
        if 'dependencies {' in content:
            content = re.sub(r'(dependencies\s*\{)', disable_apk_config + r'\1', content, count=1)
        else:
            # Append at end of android block
            content = re.sub(r'(\}\s*$)', disable_apk_config + r'\1', content, count=1, flags=re.MULTILINE)
        
        with open(build_gradle_path, 'w') as f:
            f.write(content)
        
        print("‚úÖ APK building disabled in build.gradle")
        PYTHON_SCRIPT
        
    - name: Build AAB (Android App Bundle)
      run: |
        cd android
        echo "=== Building AAB for Google Play Store ==="
        echo "Command: ./gradlew bundleRelease"
        echo "This will generate: android/app/build/outputs/bundle/release/app-release.aab"
        echo "NOT: android/app/build/outputs/apk/release/app-release.apk"
        echo ""
        # Clean any previous builds to ensure fresh AAB build
        ./gradlew clean --no-daemon || true
        # Remove any existing APK files to ensure we don't upload them
        rm -rf app/build/outputs/apk/release/*.apk || true
        echo "Removed any existing APK files"
        echo ""
        # Build ONLY AAB bundle using bundleRelease (NOT assembleRelease which builds APK)
        # Use -x assembleRelease to explicitly exclude APK building
        ./gradlew bundleRelease -x assembleRelease --no-daemon --stacktrace
        echo ""
        echo "=== Build completed ==="
        
    - name: Remove any accidentally created APK files
      run: |
        echo "=== Checking for accidentally created APK files ==="
        if [ -d "android/app/build/outputs/apk/release" ]; then
          APK_COUNT=$(find android/app/build/outputs/apk/release -name "*.apk" -type f | wc -l)
          if [ "$APK_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $APK_COUNT APK file(s) - removing them..."
            rm -f android/app/build/outputs/apk/release/*.apk
            echo "‚úÖ APK files removed"
          else
            echo "‚úÖ No APK files found (as expected)"
          fi
        else
          echo "‚úÖ No APK output directory (as expected)"
        fi
        
    - name: Check for AAB
      run: |
        echo "=== Checking for generated AAB ==="
        if [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
          echo "‚úÖ AAB found: android/app/build/outputs/bundle/release/app-release.aab"
          ls -lh android/app/build/outputs/bundle/release/
          file android/app/build/outputs/bundle/release/app-release.aab
          echo ""
          echo "=== Verifying this is an AAB file (not APK) ==="
          # AAB files are ZIP archives, verify it's not an APK
          if file android/app/build/outputs/bundle/release/app-release.aab | grep -q "Zip archive"; then
            echo "‚úÖ Confirmed: File is a ZIP archive (AAB format)"
          fi
        else
          echo "‚ùå AAB not found. Checking all bundle files:"
          find android/app/build/outputs/bundle/ -name "*.aab" -type f || echo "No AAB files found"
          echo ""
          echo "=== Checking if APK was built instead (this should not happen) ==="
          if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
            echo "‚ö†Ô∏è  WARNING: APK file found instead of AAB!"
            echo "This workflow should only build AAB files."
            ls -lh android/app/build/outputs/apk/release/
          fi
          exit 1
        fi
        
    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: tijaniyah-pro-aab-production
        path: android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 90
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: android/app/build/outputs/bundle/release/app-release.aab
        tag_name: ${{ github.ref_name }}
        name: Tijaniyah Muslim Pro ${{ github.ref_name }} - Production AAB
        body: |
          üïå **Tijaniyah Muslim Pro - Production Release**
          
          ## Android App Bundle (AAB) for Google Play Store
          
          This AAB file is ready for upload to Google Play Console.
          
          ### Build Information
          - **Version Code**: ${{ github.event.inputs.version_code || '1' }}
          - **Version Name**: ${{ github.event.inputs.version_name || '1.0.0' }}
          - **Build Date**: ${{ github.event.head_commit.timestamp || github.run_started_at }}
          
          ### Features
          - ‚úÖ Prayer Times with Location Detection
          - ‚úÖ Qibla Compass with Sensors
          - ‚úÖ Islamic Calendar (Hijri Dates)
          - ‚úÖ Azan Audio Player
          - ‚úÖ Digital Tasbih
          - ‚úÖ Islamic Lessons & Resources
          - ‚úÖ Community Features
          - ‚úÖ Donation System
          - ‚úÖ Multi-language Support
          
          ### Upload Instructions
          1. Go to [Google Play Console](https://play.google.com/console)
          2. Select your app
          3. Go to Production ‚Üí Create new release
          4. Upload the `app-release.aab` file
          5. Fill in release notes and submit for review
          
          ## Ready for Google Play Store! üöÄ
        draft: false
        prerelease: false

