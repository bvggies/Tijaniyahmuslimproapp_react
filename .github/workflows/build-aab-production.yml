name: Build AAB for Google Play Production

on:
  workflow_dispatch: # Manual trigger
    inputs:
      version_code:
        description: 'Version Code (integer)'
        required: true
        default: '1'
      version_name:
        description: 'Version Name (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
  push:
    branches:
      - main  # Trigger on push to main branch
    tags:
      - 'v*' # Trigger on version tags like v1.0.0

jobs:
  build-aab:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install dependencies
      run: |
        npm ci
        npx expo install --fix
        
    - name: Clean and generate Android project
      run: |
        # Remove existing android directory if it exists
        if [ -d "android" ]; then
          echo "Removing existing android directory"
          rm -rf android
        fi
        
        # Generate Android project
        echo "Generating Android project..."
        npx expo prebuild --platform android
        
        # Verify the project was created
        if [ -d "android" ]; then
          echo "âœ… Android project generated successfully"
        else
          echo "âŒ Android project generation failed"
          exit 1
        fi
        
    - name: Setup signing keystore
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
      run: |
        echo "Setting up signing keystore..."
        mkdir -p android/app
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
        
        # Create or update gradle.properties with signing config
        KEYSTORE_PROPERTIES="android/gradle.properties"
        echo "" >> "$KEYSTORE_PROPERTIES"
        echo "# Production signing configuration" >> "$KEYSTORE_PROPERTIES"
        echo "MYAPP_UPLOAD_STORE_FILE=upload-keystore.jks" >> "$KEYSTORE_PROPERTIES"
        echo "MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> "$KEYSTORE_PROPERTIES"
        echo "MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> "$KEYSTORE_PROPERTIES"
        echo "MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> "$KEYSTORE_PROPERTIES"
        
    - name: Update version code and name
      run: |
        # Get version from inputs (manual trigger) or use defaults
        VERSION_CODE="${{ github.event.inputs.version_code }}"
        VERSION_NAME="${{ github.event.inputs.version_name }}"
        
        # Extract version from tag if triggered by tag
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION_NAME="${GITHUB_REF#refs/tags/v}"
          # Extract version code from tag or use commit count
          if [[ -z "$VERSION_CODE" ]]; then
            VERSION_CODE=$(git rev-list --count HEAD)
          fi
        fi
        
        # Use defaults if not provided
        if [[ -z "$VERSION_CODE" ]]; then
          # Increment based on previous version or use commit count
          CURRENT_CODE=$(grep -oP 'versionCode \K[0-9]+' android/app/build.gradle 2>/dev/null || echo "0")
          VERSION_CODE=$((CURRENT_CODE + 1))
        fi
        
        if [[ -z "$VERSION_NAME" ]]; then
          VERSION_NAME="1.0.0"
        fi
        
        echo "Setting versionCode=$VERSION_CODE and versionName=$VERSION_NAME"
        
        # Update build.gradle
        sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
        sed -i "s/versionName \".*\"/versionName \"$VERSION_NAME\"/" android/app/build.gradle
        
    - name: Configure release signing in build.gradle
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
      run: |
        # Use Python to properly modify build.gradle
        python3 << 'PYTHON_SCRIPT'
        import re
        
        build_gradle_path = 'android/app/build.gradle'
        with open(build_gradle_path, 'r') as f:
            content = f.read()
        
        # Check if signingConfigs already exists
        has_signing_configs = 'signingConfigs {' in content
        
        if not has_signing_configs:
            # Add signingConfigs block before buildTypes
            signing_config = '''
    signingConfigs {
        release {
            if (project.hasProperty("MYAPP_UPLOAD_STORE_FILE")) {
                storeFile file(MYAPP_UPLOAD_STORE_FILE)
                storePassword MYAPP_UPLOAD_STORE_PASSWORD
                keyAlias MYAPP_UPLOAD_KEY_ALIAS
                keyPassword MYAPP_UPLOAD_KEY_PASSWORD
            }
        }
    }
'''
            # Insert before buildTypes
            content = re.sub(r'(buildTypes\s*{)', signing_config + r'\1', content, count=1)
        else:
            # Add release config to existing signingConfigs
            release_config = '''
        release {
            if (project.hasProperty("MYAPP_UPLOAD_STORE_FILE")) {
                storeFile file(MYAPP_UPLOAD_STORE_FILE)
                storePassword MYAPP_UPLOAD_STORE_PASSWORD
                keyAlias MYAPP_UPLOAD_KEY_ALIAS
                keyPassword MYAPP_UPLOAD_KEY_PASSWORD
            }
        }'''
            # Insert after signingConfigs {
            content = re.sub(r'(signingConfigs\s*\{)', r'\1' + release_config, content, count=1)
        
        # Update release buildType to use production signing
        # Replace debug signing with release signing
        content = re.sub(
            r'signingConfig\s+signingConfigs\.debug',
            'signingConfig signingConfigs.release',
            content
        )
        
        # If no signingConfig in release block, add it
        if 'release {' in content and 'signingConfig' not in content.split('release {')[1].split('}')[0]:
            content = re.sub(
                r'(release\s*\{[^}]*?)(\})',
                r'\1            signingConfig signingConfigs.release\n        \2',
                content,
                flags=re.DOTALL
            )
        
        with open(build_gradle_path, 'w') as f:
            f.write(content)
        
        print("âœ… Signing configuration updated successfully")
        PYTHON_SCRIPT
        
    - name: Make gradlew executable
      run: |
        cd android
        chmod +x gradlew
        echo "Gradle wrapper is now executable"
        
    - name: Verify Gradle tasks
      run: |
        cd android
        echo "=== Available Gradle tasks ==="
        ./gradlew tasks --all --no-daemon | grep -E "(bundle|assemble)" || true
        echo ""
        echo "=== Verifying bundleRelease task exists ==="
        if ./gradlew tasks --all --no-daemon | grep -q "bundleRelease"; then
          echo "âœ… bundleRelease task found - will build AAB"
        else
          echo "âŒ bundleRelease task not found!"
          exit 1
        fi
        
    - name: Build AAB (Android App Bundle)
      id: build-aab
      run: |
        cd android
        echo "=== Building AAB for Google Play Store ==="
        echo "Command: ./gradlew bundleRelease"
        echo "This will generate: android/app/build/outputs/bundle/release/app-release.aab"
        echo ""
        # Clean any previous builds to ensure fresh build
        ./gradlew clean --no-daemon || true
        # Build AAB bundle
        if ./gradlew bundleRelease --no-daemon --stacktrace; then
          echo "âœ… AAB build succeeded"
          echo "aab_built=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ AAB build failed!"
          echo "aab_built=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo ""
        echo "=== AAB build completed ==="
        
    - name: Build APK (for direct distribution/testing)
      id: build-apk
      run: |
        cd android
        echo "=== Building APK for direct distribution ==="
        echo "Command: ./gradlew assembleRelease"
        echo "This will generate: android/app/build/outputs/apk/release/app-release.apk"
        echo ""
        # Build APK (reuses compiled code from AAB build, so it's fast)
        if ./gradlew assembleRelease --no-daemon --stacktrace; then
          echo "âœ… APK build succeeded"
          echo "apk_built=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ APK build failed!"
          echo "apk_built=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo ""
        echo "=== APK build completed ==="
        
    - name: Verify build outputs
      run: |
        echo "=== Checking for generated AAB ==="
        if [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
          echo "âœ… AAB found: android/app/build/outputs/bundle/release/app-release.aab"
          ls -lh android/app/build/outputs/bundle/release/
          file android/app/build/outputs/bundle/release/app-release.aab
          AAB_SIZE=$(stat -f%z android/app/build/outputs/bundle/release/app-release.aab 2>/dev/null || stat -c%s android/app/build/outputs/bundle/release/app-release.aab 2>/dev/null || echo "unknown")
          echo "AAB size: $AAB_SIZE bytes"
        else
          echo "âŒ AAB not found in expected location!"
          echo "Searching for AAB files..."
          find android/app/build/outputs/bundle/ -name "*.aab" -type f || echo "No AAB files found anywhere"
          echo "Listing bundle directory:"
          ls -la android/app/build/outputs/bundle/release/ 2>/dev/null || echo "Bundle directory doesn't exist"
          exit 1
        fi
        
        echo ""
        echo "=== Checking for generated APK ==="
        if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
          echo "âœ… APK found: android/app/build/outputs/apk/release/app-release.apk"
          ls -lh android/app/build/outputs/apk/release/
          file android/app/build/outputs/apk/release/app-release.apk
          APK_SIZE=$(stat -f%z android/app/build/outputs/apk/release/app-release.apk 2>/dev/null || stat -c%s android/app/build/outputs/apk/release/app-release.apk 2>/dev/null || echo "unknown")
          echo "APK size: $APK_SIZE bytes"
        else
          echo "âŒ APK not found in expected location!"
          echo "Searching for APK files..."
          find android/app/build/outputs/apk/ -name "*.apk" -type f || echo "No APK files found anywhere"
          echo "Listing APK directory:"
          ls -la android/app/build/outputs/apk/release/ 2>/dev/null || echo "APK directory doesn't exist"
          exit 1
        fi
        
    - name: Upload AAB artifact
      if: steps.build-aab.outputs.aab_built == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tijaniyah-pro-aab-production
        path: android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 90
        if-no-files-found: error
        
    - name: Upload APK artifact
      if: steps.build-apk.outputs.apk_built == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tijaniyah-pro-apk-production
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 90
        if-no-files-found: error
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          android/app/build/outputs/bundle/release/app-release.aab
          android/app/build/outputs/apk/release/app-release.apk
        tag_name: ${{ github.ref_name }}
        name: Tijaniyah Muslim Pro ${{ github.ref_name }} - Production Release
        body: |
          ðŸ•Œ **Tijaniyah Muslim Pro - Production Release**
          
          ## Build Artifacts
          
          This release includes both AAB and APK files:
          
          - **AAB (Android App Bundle)**: For Google Play Store upload
          - **APK**: For direct distribution and testing
          
          ### Build Information
          - **Version Code**: ${{ github.event.inputs.version_code || '1' }}
          - **Version Name**: ${{ github.event.inputs.version_name || '1.0.0' }}
          - **Build Date**: ${{ github.event.head_commit.timestamp || github.run_started_at }}
          
          ### Features
          - âœ… Prayer Times with Location Detection
          - âœ… Qibla Compass with Sensors
          - âœ… Islamic Calendar (Hijri Dates)
          - âœ… Azan Audio Player
          - âœ… Digital Tasbih
          - âœ… Islamic Lessons & Resources
          - âœ… Community Features
          - âœ… Donation System
          - âœ… Multi-language Support
          
          ### Upload Instructions
          
          **For Google Play Store:**
          1. Go to [Google Play Console](https://play.google.com/console)
          2. Select your app
          3. Go to Production â†’ Create new release
          4. Upload the `app-release.aab` file
          5. Fill in release notes and submit for review
          
          **For Direct Distribution:**
          - Use the `app-release.apk` file for direct installation or testing
          
          ## Ready for Distribution! ðŸš€
        draft: false
        prerelease: false

